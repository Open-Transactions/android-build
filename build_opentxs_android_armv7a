#!/bin/bash

source "${HOME}"/bin/android-armv7a

export LOCAL_SOURCE_DIR="${SRC_DIR}/${FOLDER_OPENTXS_OT}"
export LOCAL_BUILD_DIR="${BUILD_DIR}/${FOLDER_OPENTXS_OT}"
export TOOLCHAIN_LIBRARY_MAIN="libopentxs.so"
export TOOLCHAIN_LIBRARY_SWIG="libJOpentxs.so"
export OUTPUT_LIBRARY_MAIN="libopentxs.so"
export OUTPUT_LIBRARY_SWIG="libJOpentxs.so"

clean_directories "${LOCAL_BUILD_DIR}" "${LOCAL_SOURCE_DIR}" ""

set -e

create_directories "${LOCAL_SOURCE_DIR}" "${LOCAL_BUILD_DIR}" "${FINAL_OUTPUT_DIR_LIB_OT}"
git_clone_source "${OPENTXS_VERSION_OT}" "${GIT_OPENTXS_URL}" "${LOCAL_SOURCE_DIR}"

sed -i "s~#include \"opentxs/core/util/android_string.hpp\"~~" "${LOCAL_SOURCE_DIR}"/include/opentxs/stdafx.hpp
sed -i "s~#include \"opentxs/core/util/android_string.hpp\"~~" "${LOCAL_SOURCE_DIR}"/include/opentxs/client/commands/CmdBase.hpp
sed -i "s~\(#include <memory>.*\)~#include <ctime>\n\1~" "${LOCAL_SOURCE_DIR}"/include/opentxs/core/util/Common.hpp
sed -i "s~return time(nullptr)~return std::time(nullptr)~" "${LOCAL_SOURCE_DIR}"/include/opentxs/core/util/Common.hpp
sed -i "s/-Wuseless-cast,//" "${LOCAL_SOURCE_DIR}"/CMakeLists.txt
sed -i "s/-Wno-useless-cast,//" "${LOCAL_SOURCE_DIR}"/CMakeLists.txt

cd "${LOCAL_BUILD_DIR}"

cmake \
 -DCMAKE_C_COMPILER="${CMAKE_C_COMPILER}" \
 -DCMAKE_CXX_COMPILER="${CMAKE_CXX_COMPILER}" \
 -DCMAKE_CXX_FLAGS="" \
 -DUSE_CCACHE=no \
 -DCMAKE_TOOLCHAIN_FILE="${ANDROID_TOOLCHAIN_FILE}" \
 -DCMAKE_INSTALL_PREFIX="${TOOLCHAIN_USR_OT}" \
 -DJAVA=ON \
 -DANDROID=ON \
 -DOT_STRICT=OFF \
 -DOT_STORAGE_FS=OFF \
 -DOT_STORAGE_SQLITE=ON \
 -DOPENSSL_INCLUDE_DIR="${TOOLCHAIN_SYSROOT_INCLUDE_DIR_OT}" \
 -DOPENSSL_CRYPTO_LIBRARY="${TOOLCHAIN_SYSROOT_LIB_DIR_OT}/libcrypto.so" \
 -DOPENSSL_SSL_LIBRARY="${TOOLCHAIN_SYSROOT_LIB_DIR_OT}/libssl.so" \
 -DProtobuf_LIBRARIES="${TOOLCHAIN_SYSROOT_LIB_DIR_OT}/libprotobuf-lite.so" \
 -DProtobuf_LITE_LIBRARY="${TOOLCHAIN_SYSROOT_LIB_DIR_OT}/libprotobuf-lite.so" \
 -DProtobuf_INCLUDE_DIR="${TOOLCHAIN_SYSROOT_INCLUDE_DIR_OT}" \
 -DSODIUM_INCLUDE_DIR="${TOOLCHAIN_SYSROOT_INCLUDE_DIR_OT}" \
 -DSODIUM_LIBRARY="${TOOLCHAIN_SYSROOT_LIB_DIR_OT}/libsodium.so" \
 -DLIBSECP256K1_INCLUDE_DIR="${TOOLCHAIN_SYSROOT_INCLUDE_DIR_OT}" \
 -DLIBSECP256K1_LIBRARY="${TOOLCHAIN_SYSROOT_LIB_DIR_OT}/libsecp256k1.so" \
 -DCZMQ_INCLUDE_DIRS="${TOOLCHAIN_SYSROOT_INCLUDE_DIR_OT}" \
 -DCZMQ_LIBRARIES="${TOOLCHAIN_SYSROOT_LIB_DIR_OT}/libczmq.so" \
 -DSQLITE3_INCLUDE_DIR="${TOOLCHAIN_SYSROOT_INCLUDE_DIR_OT}" \
 -DOPENTXS_PROTO_INCLUDE_DIRS="${TOOLCHAIN_SYSROOT_INCLUDE_DIR_OT}" \
 -DOPENTXS_PROTO_LIBRARIES="${TOOLCHAIN_SYSROOT_LIB_DIR_OT}/libopentxs-proto.so" \
 "${LOCAL_SOURCE_DIR}"

cmake \
 -DCMAKE_C_COMPILER="${CMAKE_C_COMPILER}" \
 -DCMAKE_CXX_COMPILER="${CMAKE_CXX_COMPILER}" \
 -DCMAKE_CXX_FLAGS="" \
 -DUSE_CCACHE=no \
 -DCMAKE_TOOLCHAIN_FILE="${ANDROID_TOOLCHAIN_FILE}" \
 -DCMAKE_INSTALL_PREFIX="${TOOLCHAIN_USR_OT}" \
 -DJAVA=ON \
 -DANDROID=ON \
 -DOT_STRICT=OFF \
 -DOT_STORAGE_FS=OFF \
 -DOT_STORAGE_SQLITE=ON \
 -DOPENSSL_INCLUDE_DIR="${TOOLCHAIN_SYSROOT_INCLUDE_DIR_OT}" \
 -DOPENSSL_CRYPTO_LIBRARY="${TOOLCHAIN_SYSROOT_LIB_DIR_OT}/libcrypto.so" \
 -DOPENSSL_SSL_LIBRARY="${TOOLCHAIN_SYSROOT_LIB_DIR_OT}/libssl.so" \
 -DProtobuf_LIBRARIES="${TOOLCHAIN_SYSROOT_LIB_DIR_OT}/libprotobuf-lite.so" \
 -DProtobuf_LITE_LIBRARY="${TOOLCHAIN_SYSROOT_LIB_DIR_OT}/libprotobuf-lite.so" \
 -DProtobuf_INCLUDE_DIR="${TOOLCHAIN_SYSROOT_INCLUDE_DIR_OT}" \
 -DSODIUM_INCLUDE_DIR="${TOOLCHAIN_SYSROOT_INCLUDE_DIR_OT}" \
 -DSODIUM_LIBRARY="${TOOLCHAIN_SYSROOT_LIB_DIR_OT}/libsodium.so" \
 -DLIBSECP256K1_INCLUDE_DIR="${TOOLCHAIN_SYSROOT_INCLUDE_DIR_OT}" \
 -DLIBSECP256K1_LIBRARY="${TOOLCHAIN_SYSROOT_LIB_DIR_OT}/libsecp256k1.so" \
 -DCZMQ_INCLUDE_DIRS="${TOOLCHAIN_SYSROOT_INCLUDE_DIR_OT}" \
 -DCZMQ_LIBRARIES="${TOOLCHAIN_SYSROOT_LIB_DIR_OT}/libczmq.so" \
 -DSQLITE3_INCLUDE_DIR="${TOOLCHAIN_SYSROOT_INCLUDE_DIR_OT}" \
 -DOPENTXS_PROTO_INCLUDE_DIRS="${TOOLCHAIN_SYSROOT_INCLUDE_DIR_OT}" \
 -DOPENTXS_PROTO_LIBRARIES="${TOOLCHAIN_SYSROOT_LIB_DIR_OT}/libopentxs-proto.so" \
 "${LOCAL_SOURCE_DIR}"

sed -i "s/soname, /soname,libJOpentxs.so /" "${LOCAL_BUILD_DIR}"/wrappers/java/CMakeFiles/JOpentxs.dir/link.txt

make "${OT_MAKE_OPTS}"
make install

mkdir -p "${FINAL_OUTPUT_DIR_JAVA_OPENTXS_OT}"

cp "${CXXSTL_LIB}/lib${ANDROID_STL_LIB}.so" "${FINAL_OUTPUT_DIR_LIB_OT}"
cp "${TOOLCHAIN_SYSROOT_LIB_DIR_OT}/${TOOLCHAIN_LIBRARY_MAIN}" "${FINAL_OUTPUT_DIR_LIB_OT}/${OUTPUT_LIBRARY_MAIN}"
cp "${TOOLCHAIN_SYSROOT_LIB_DIR_OT}/${TOOLCHAIN_LIBRARY_SWIG}" "${FINAL_OUTPUT_DIR_LIB_OT}/${OUTPUT_LIBRARY_SWIG}"
rpl -R -e ".so.9" "_9.so" "${FINAL_OUTPUT_DIR_LIB_OT}/${OUTPUT_LIBRARY_MAIN}"
rpl -R -e ".so.1.0.0" "_1_0_0.so" "${FINAL_OUTPUT_DIR_LIB_OT}/${OUTPUT_LIBRARY_MAIN}"
